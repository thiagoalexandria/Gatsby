---
title: Configuração de um servidor Apache
description: "Nesse tutorial será explicado como configurar o Apache em um servidor com CentOS 7, desde a sua instalação até a configuração de vhosts e instalação de módulos.\_Nesse artigo será utilizado a versão 2.4 do apache em uma instalação Minimal do CentOs 7."
date: '2020-01-22 05:00:23'
category: linux
background: '#EE0000'
---
## 1. Configuração do hostname

Antes de seguir com a configuração do Apache, iremos configurar o hostname do servidor da seguinte forma "meu-site.com.br" no qual você deve substituir pelo teu domínio do teu servidor, para isso será utilizado o seguinte comando:

```bash
hostnamectl set-hostname meu-site.com.br
```

Após ajustar o hostname, verifique é o nome configurado é retornado após utilizar o comando abaixo:

```bash
hostnamectl status
```

Feito isso, edite o arquivo hosts em seu /etc/hosts com o editor de sua preferência

```bash
vi /etc/hosts
```

## 2. Instalação e configuração do Apache

Configurado o hostname seguiremos com a instalação e configuração do serviço web no servidor, para isso basta seguir com a instalação do serviço httpd e alguns utilitários através do gerenciador de pacotes:

```bash
yum install -y httpd wget htop
```

Feito a instalação utilizando o gerenciador de pacotes inicie o serviço para verificar o seu funcionamento

```bash
systemctl start httpd
systemctl status httpd
```

### 2.1 Ajustes de configuração do sistema operacional

Para que o servidor funcione sem maiores problemas é necessário seguir alguns passos para liberação de porta no firewall e desativar o selinux para não realizar bloqueios nas aplicações, dessa forma escolha a forma com que se sente mais familiarizado :

A: Desabilite o firewalld e utilize o iptables como firewall

```bash  
systemctl stop firewalld
systemctl disable firewalld
```

Nesse teste iremos utilizar apenas ipv4 então desativaremos as configurações de ipv6 do iptables e das configurações de rede:

```bash
service ip6tables stop
chkconfig ip6tables off
sed -i 's/IPV6INIT\=\"yes\"/IPV6INIT\=\"no\"/g' /etc/sysconfig/network-scripts/ifcfg-eth0
echo -e 'net.ipv6.conf.all.disable_ipv6 = 1\n' >> /etc/sysctl.conf
echo -e 'NETWORKING_IPV6=no\n' >> /etc/sysconfig/network
```

  Após feito, liberar a porta 80 e 443 no iptables:

```bash
iptables -I INPUT -p tcp --dport 80 -j ACCEPT
iptables -I INPUT -p tcp --dport 443 -j ACCEPT
 /sbin/service iptables save 
```

B: Liberar a porta 80 e 443 no firewalld

```bash
firewall-cmd --permanent --add-port=80/tcp
firewall-cmd --permanent --add-port=443/tcp
firewall-cmd --reload
```

Configurado  o firewall será feito o ajuste dos limites de segurança e desativação do selinux no servidor, para isso siga com o passo determinado abaixo:

```bash
echo -e '* soft    nofile  1024\n' >> /etc/security/limits.conf
echo -e '* hard    nofile  65535\n' >> /etc/security/limits.conf
echo -e 'sesssion required /lib64/security/pam_limits.so\n' >> /etc/pam.d/login
echo -e 'fs.file-max = 65535\n' >> /etc/sysctl.conf
sed -i "s/SELINUX=.*/SELINUX=disabled/" /etc/sysconfig/selinux
```

### 2.2 Estrutura do Apache

O Apache, assim como todo outro serviço possui caminho para os seus arquivos de configuração, para acessar esses arquivos basta seguir com o acesso ao seguinte diretório:

```bash
/etc/httpd
```

Nesse diretório é possível verificar alguns outros diretórios responsáveis pela estrutura do apache, são esses os conf, conf.d, logs, modules e run, abaixo é possível verificar as configurações armazenadas:

```bash
# Arquivo de configuração principal, responsável por iniciar e determinar as configurações iniciais do serviço Web
/etc/httpd/conf
# Diretório para realização de includes de configuração
/etc/httpd/conf.d
# Diretório padrão para armazenamento de logs
logs -> ../../var/log/httpd
# Link simbólico para as bibliotecas de módulos instalados
modules -> ../../usr/lib64/apache2/modules
# Informações sobre o processo ativo
run -> ../../var/run/apache2
```

## 3. Configuração de aplicação Web

### 3.1 Instalar e configurar o modulo php

Nesse passo não se tem restrições, caso deseje instalar a versão disponibilizada pelo yum basta seguir com a instalação, para verificar qual a versão disponível basta verificar utilizando a opção info do gerenciador de pacotes:

```bash
yum info php
```

Se estiver de acordo, basta seguir com a instalação:

```bash
yum install php
```

Como a versão disponibilizada já encontra-se em end-of-life será instalado a versão 7.0 do php, para isso basta seguir os seguintes passos, ativando os repositórios Epel e Remi:

```bash
yum install https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm
yum install http://rpms.remirepo.net/enterprise/remi-release-7.rpm
```

Em seguida é necessário instalar o yum-utils, para poder manusear os repositórios e pacotes que serão instalados:

```bash
yum install yum-utils
```

Instalado o yum-utils,  basta escolher a versão do PHP que deseja, para isso selecione o pacote:

````bash
yum-config-manager --enable remo-php70   [Install PHP 7.0]
yum-config-manager --enable remi-php71   [Install PHP 7.1]
yum-config-manager --enable remi-php72   [Install PHP 7.2]
yum-config-manager --enable remi-php73   [Install PHP 7.3]
```

Configurado a versão siga com a instalação dos módulos:

```bash
yum install php php-mcrypt php-cli php-gd php-curl php-mysql php-ldap php-zip php-fileinfo
````

Certifique-se de que a versão foi instalada corretamente:

```bash
php -v
```

Criaremos o arquivo Virtual Host o nosso domínio diretamente no /etc/httpd/conf.d/www.apachevm.conf

```bash
<VirtualHost *:80>
    ServerAdmin webmaster@apachevm.com
    DocumentRoot /var/www/apachevm/html/videopage
    ServerName www.apachevm.com
    ErrorLog logs/www.apachevm.com-error_log
    CustomLog logs/www.apachevm-access_log common
</VirtualHost>
```

## 4. Configuração de Logs

### 4.1 Funcionamento dos logs

É possível personalizar como as informações são armazenadas, os seus níveis de criticidade e o formato dos logs. 

* Log level

  * Define o nível de criticidade do log do Apache
  * Configurado no httpd.conf
  * Default: LogLevel warn
* LogFormat

  * Cria aliases para formatação de logs
  * Evita poluir as configurações de VirtualHosts
  * Possibilidade de criar diversos logs com formatos diferentes
* Custom log

  * *Configurável no Virtual Host*
  * É possível criar diversos arquivos de acordo com o LogFormat
* Rotate logs

  * *Permite gravar um arquivo através de outro comando*
  * rotatelogs: comando para gerenciar rotação de logs
  * Rotacionar por tamanho ou por tempo

### 4.2 Criticidade de logs

Existem diversas opções para configuração do LogLevel do apache, segue abaixo uma tabela com as opções e as suas descrições:

| Level  | Descrição                   | Exemplo                                                                             |
| ------ | --------------------------- | ----------------------------------------------------------------------------------- |
| emerg  | Emergência                  | "Child cannot open lock file. Exiting"                                              |
| alert  | Uma ação precisa ser tomada | "getpwuid: couldn't determine user name from uid"                                   |
| crit   | Alertas Criticos            | "Socket: Failed to get a socket, exiting child"                                     |
| error  | Condições de error          | "Premature end of script headers"                                                   |
| warn   | Warning                     | "Child process 1234 did not exit, sending another SIGHUP"                           |
| notice | Notificações significantes  | "httpd: caught SIGBUS, attempting to dump core in..."                               |
| info   | Informativo                 | "Server seems busy, (you may need to increase StartServer, or Min/MaxSpareServers)" |
| debug  | Debug-level messages        | "Opening config file ..."                                                           |



Para configuração do LogLevel basa seguir com a edição direta do arquivo de configuração do apache na variável LogLevel:

```bash
vim /etc/httpd/conf/httpd.conf
```

Feito o ajuste, basta reiniciar o serviço web

```bash
service httpd restart
```

### 4.3 LogFormat

O log format pode ser ajustado de diversas formas, adaptando-se a sua necessidade sobre os itens que deve ser logados, abaixo segue alguns exemplos:

```bash
LogFormat "%h %I %u %t \"%r\" %>s %b" common
LogFormat "%{Referer}i -> %U" referer
LogFormat "%{User-Agent}i" agent
```

Para ajustar ou adicionar informações de LogFormat, basta seguir com a edição do arquivo de configuração do apache e buscar por LogFormat

```bash
vim /etc/httpd/conf/httpd.conf
```

Nesse caso, foi feito a criação de um LogFormat customizado

```bash
LogFormat "%h %t \"%r\" %>s %b \"%{User-Agent}i\" **%T/%D** newformat
# %h host
# %t time
# %r request
# %S status
# %b bytes
# Useagent browser
# %t time em segundos
# %D tempo em décimos de segundos%h host
# %t time
# %r request
# %S status
# %b bytes
# Useagent browser
# %T time em segundos
# %D tempo em décimos de segundos
```

Salve o arquivo de configuração e seguiremos com o ajuste no Virtual Host que desejamos que o utilize

```
vim /etc/httpd/conf.d/www.apachevm.conf
CustomLog logs/www.apachevm-access_log newformat
```

Salvo o arquivo, basta reiniciar o serviço web.
```bash
service httpd restart
```

## 5. Boas práticas de segurança

Existem algumas ações básicas que podem ser adotadas para manter o seu ambiente mais seguro, os pontos abaixo são as medidas primordiais e quase sempre ignoradas, indico que siga com a aplicação das soluções que vamos abordar para evitar ataques por misconfiguration.

### 5.1 Desligar modo TRACE

Trace é um método que em conjunto com o XSS, dessa forma ele pode ter acesso a informações sensíveis do seu cliente, uma delas é o acesso aos cookies e dados de autenticação então é muito importante que o Trace esteja desativado. 

Para verificar se o trace esta habilitado, basta executar o comando abaixo:

```bash
$ curl -X TRACE 127.0.0.1
TRACE / HTTP/1.1
User-Agent: curl/7.24.0 (x86_64-apple-darwin12.0) libcurl/7.24.0 OpenSSL/0.9.8r zlib/1.2.5
Host: 127.0.0.1
Accept: */*
```

Observe que caso solicitado, os cookies são retornados através dessa solicitação:

```bash
$ curl -X TRACE -H "Cookie: name=value" 127.0.0.1
TRACE / HTTP/1.1
User-Agent: curl/7.24.0 (x86_64-apple-darwin12.0) libcurl/7.24.0 OpenSSL/0.9.8r zlib/1.2.5
Host: 127.0.0.1
Accept: */*
Cookie: name=value
```

Para desabilitar, basta ajustar a diretiva TraceEnable para "off" diretamente no arquivo de configuração, após feito basta reiniciar o Apache

```bash
TraceEnable off
```

Para verificar se os ajustes foram aplicados, basta executar o comando abaixo e terá o seguinte retorno

```bash
$ curl -X TRACE 127.0.0.1
<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML 2.0//EN">
<html><head>
<title>405 Method Not Allowed</title>
</head><body>
<h1>Method Not Allowed</h1>
<p>The requested method TRACE is not allowed for the URL /.</p>
</body></html>
```

### 5.2 Ocultar informações do Apache
### 5.3 Negar acesso a diretórios
### 5.6 Como proteger versão PHP
